<!DOCTYPE html>
<html lang="en-us"><head><meta charset="utf-8">
<meta http-equiv="content-type" content="text/html">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title itemprop="name"> | David Vargas</title>
<meta property="og:title" content=" | David Vargas" />
<meta name="twitter:title" content=" | David Vargas" />
<meta itemprop="name" content=" | David Vargas" />
<meta name="application-name" content=" | David Vargas" />
<meta property="og:site_name" content="davidvargas.xyz" />

<meta name="description" content="David Vargas&#39;s blog">
<meta itemprop="description" content="David Vargas&#39;s blog" />
<meta property="og:description" content="David Vargas&#39;s blog" />
<meta name="twitter:description" content="David Vargas&#39;s blog" />

<meta property="og:locale" content="en-us" />
<meta name="language" content="en-us" />

  <link rel="alternate" hreflang="en-gb" href="https://davidvargas.xyz/tools/containers/skaffold/" title="" />






<meta name="generator" content="Hugo 0.134.3">

    
    <meta property="og:url" content="https://davidvargas.xyz/tools/containers/skaffold/">
  <meta property="og:site_name" content="David Vargas">
  <meta property="og:title" content="David Vargas">
  <meta property="og:description" content="Last week, we took a look at the key differences between Docker Swarm and Kubernetes. You’ve built your infrastructure and deployed the first version of your program. How do you make sure that new code and container images are defect free? And do this automatically to reduce the complexity of your system? Here are two tools to build, test, and deploy code.
Once a software engineer has introduced a new bug fix or feature update in a version control system such as Git. You want to run your code through a series of step:">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="tools">


    
    
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="David Vargas">
  <meta name="twitter:description" content="Last week, we took a look at the key differences between Docker Swarm and Kubernetes. You’ve built your infrastructure and deployed the first version of your program. How do you make sure that new code and container images are defect free? And do this automatically to reduce the complexity of your system? Here are two tools to build, test, and deploy code.
Once a software engineer has introduced a new bug fix or feature update in a version control system such as Git. You want to run your code through a series of step:">


    

    <link rel="canonical" href="https://davidvargas.xyz/tools/containers/skaffold/">
    <link href="/style.min.1915b95fdbf4046da0032dde0fb966271ed904fa9c019f9a326d7ce001902895.css" rel="stylesheet">
    <link href="/code-highlight.min.706d31975fec544a864cb7f0d847a73ea55ca1df91bf495fd12a177138d807cf.css" rel="stylesheet">

    
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg">
    <link rel="shortcut icon" href="/favicon.ico">




<link rel="manifest" href="https://davidvargas.xyz/site.webmanifest">

<meta name="msapplication-config" content="/browserconfig.xml">
<meta name="msapplication-TileColor" content="#2d89ef">
<meta name="theme-color" content="#434648">

    
    <link rel="icon" type="image/svg+xml" href="/icons/favicon.svg">

    
    </head>
<body data-theme = "dark" class="notransition">

<script src="/js/theme.min.8961c317c5b88b953fe27525839672c9343f1058ab044696ca225656c8ba2ab0.js" integrity="sha256-iWHDF8W4i5U/4nUlg5ZyyTQ/EFirBEaWyiJWVsi6KrA="></script>

<div class="navbar" role="navigation">
    <nav class="menu" aria-label="Main Navigation">
        <a href="https://davidvargas.xyz/" class="logo">
            <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" 
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" 
stroke-linejoin="round" class="feather feather-home">
<title>Home</title>
<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
<polyline points="9 22 9 12 15 12 15 22"></polyline>
</svg>
        </a>
        <input type="checkbox" id="menu-trigger" class="menu-trigger" />
        <label for="menu-trigger">
            <span class="menu-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" stroke="currentColor" fill="none" viewBox="0 0 14 14"><title>Menu</title><path stroke-linecap="round" stroke-linejoin="round" d="M10.595 7L3.40726 7"></path><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 3.51488L3.49301 3.51488"></path><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 10.4851H3.49301"></path><path stroke-linecap="round" stroke-linejoin="round" d="M0.5 12.5V1.5C0.5 0.947715 0.947715 0.5 1.5 0.5H12.5C13.0523 0.5 13.5 0.947715 13.5 1.5V12.5C13.5 13.0523 13.0523 13.5 12.5 13.5H1.5C0.947715 13.5 0.5 13.0523 0.5 12.5Z"></path></svg>
            </span>
        </label>

        <div class="trigger">
            <ul class="trigger-container">
                
                
                <li>
                    <a class="menu-link " href="/">
                        home
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link " href="/posts/">
                        posts
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link " href="/notes/">
                        notes
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link " href="/readings/">
                        readings
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link " href="/about">
                        about
                    </a>
                    
                </li>
                
                <li class="menu-separator">
                    <span>|</span>
                </li>
                
                
            </ul>
            <a id="mode" href="#">
                <svg xmlns="http://www.w3.org/2000/svg" class="mode-sunny" width="21" height="21" viewBox="0 0 14 14" stroke-width="1">
<title>LIGHT</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></circle><line x1="7" y1="0.5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="0.5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line></g></svg>
                <svg xmlns="http://www.w3.org/2000/svg" class="mode-moon" width="21" height="21" viewBox="0 0 14 14" stroke-width="1">
<title>DARK</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></circle><line x1="7" y1="0.5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="0.5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line></g></svg>
            </a>
        </div>
    </nav>
</div>

<div class="wrapper post">
    <main class="page-content" aria-label="Content">
        <article>
            <header class="header">
                <h1 class="header-title"></h1>
                
            </header>
            
            <div class="page-content">
                <p>Last week, we took a look at the <a href="https://www.travis-ci.com/blog/products/docker-swarm-vs-kubernetes/">key differences between Docker Swarm and Kubernetes</a>. You&rsquo;ve built your infrastructure and deployed the first version of your program. How do you make sure that new code and  container images are defect free? And do this automatically to reduce the complexity of your system? Here are two tools to build, test, and deploy code.</p>
<p>Once a software engineer has introduced a new bug fix or feature update in a version control system such as Git. You want to run your code through a series of step:</p>
<ol>
<li>Detect changes in the code repository and build a new container image.</li>
<li>Test the new image for vulnerabilities, run units tests, and test the functionality.</li>
<li>Build and artifact for the CD stage. Where it is deployed.</li>
</ol>
<h2 id="using-skaffold-to-automate-continuous-integration">Using Skaffold to automate Continuous Integration.</h2>
<p>Skaffold is a CD tool that watches for code changes in a repository. Then it builds, tests, and deploys an application in Kubernetes. Skaffold watches source code for changes. When it detects a change, it will first build a container image that container the new changes. Once that is done, it will test the image for changes.</p>
<p>The testing is broken down into three parts:</p>
<ol>
<li>Unit Tests</li>
<li>Integration Tests</li>
<li>Security Scans</li>
</ol>
<p>Too see how this works. Let&rsquo;s take a look at a skaffold.yaml file. Which is the core configuration file for Skaffold.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">build</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">artifacts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">project/code</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">local</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">test</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">project/code</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">custom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span>- <span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;sftp -oBatchMode=no -oStrictHostKeyChecking=no user@localhost&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">structureTests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">./container-structure-tool/structure-tool.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">deploy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">kubectl</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nt">manifests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span>- <span class="l">kubernetes/*</span><span class="w">
</span></span></span></code></pre></div><p>The testing section here runs a command in the container to verify a certain functionality. Then it uses our second tool, <code>container-structure-test</code>, to verify container metadata, environment variables, and other command outputs.</p>
<p>The structureTests directive points to the container-structure-test tool&rsquo;s yaml file:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">commandTests</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">	</span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;sftp-server&#34;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">	</span>- <span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;sftp&#34;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">	</span>- <span class="nt">args</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">	  </span>- <span class="s2">&#34;-oBatchMode=no&#34;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">	  </span>- <span class="s2">&#34;-oStrictHostKeyChecking=no&#34;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">	  </span>- <span class="s2">&#34;user@localhost&#34;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">	</span>- <span class="nt">expectedOutput</span><span class="p">:</span><span class="w"> </span>- <span class="s2">&#34;Connected to localhost.&#34;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadataTest</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">env</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">	  </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">SFTP_PORT </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	  </span>- <span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="m">22</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">cmd</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;./sftp-server&#34;</span><span class="p">]</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">workdir</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;/app&#34;</span><span class="w">
</span></span></span></code></pre></div><hr>
<p>How can I validate the structure of a container image?</p>
<p>How do you run tests on a new version of your application and automate the creation of a new container?</p>
<p>Set up an automation that watches source code for changes. If there are changes, then you will have a set of step ready to go that deploy to a K8s cluster, VMs, or your chosen Cloud provider.</p>
<p>Build &gt; test &gt; deploy</p>
<p>Skaffold is a CD tool for kubernetes-native applications.
Container-structure test will check and verify the structure of and image after it is built.</p>
<ul>
<li>can verify specific files exist</li>
<li>Can run commands and verify output.</li>
<li>Can verify container metadata set in a dockerfile such and environment variables, ports</li>
</ul>
<p>Skaffold will give you a template to build and test your code in the same way. This helps produce a consistent product and makes automatic deployment easier.</p>
<p>During the testing phase,</p>
<ul>
<li>Unit tests</li>
<li>Integration Tests
<ul>
<li>Does the application integrate within the rest of you environment?</li>
</ul>
</li>
<li>Security Scans
<ul>
<li>Check for known security vulnerabilities in software or imported container images.</li>
</ul>
</li>
</ul>
<p>Artifact is then built and sent to a repo that the CD phase has access to.</p>
<p>The CD Takes the artifact and deploys it using one of three strategies:</p>
<ul>
<li>Canary
<ul>
<li>Like sending a canary into a cole mine. If a select group of users survive, then the code is pushed out to everyone.</li>
</ul>
</li>
<li>Rolling
<ul>
<li>Deploys new code slowly along side of current code until all the new code is fully deployed.</li>
</ul>
</li>
<li>blue-green
<ul>
<li>Green (new) code is tested along side of blue (current)  code. If the green code is good, then it is deployed.</li>
</ul>
</li>
</ul>
<p>Monitoring is deployed to watch for errors, latency, etc. If a problem is detected then the code can be rolled back.</p>
<p>skaffold.yaml</p>
<ul>
<li>Provides instructions on building, testing, and deploying an application.</li>
<li>Located in root of project</li>
<li>Keep this file under version control</li>
<li>Three main sections:
<ul>
<li>build
<ul>
<li>how to build the image</li>
</ul>
</li>
<li>test
<ul>
<li>tests to perform on the image</li>
</ul>
</li>
<li>deploy
<ul>
<li>How to deploy to kubernetes</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">sftp-server</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">build</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">artifacts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">project/code</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">local</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">test</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">project/code</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">custom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span>- <span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;npm --prefix ./src test&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">structureTests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">./container-structure-tool/structure-tool.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">deploy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">kubectl</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nt">manifests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span>- <span class="l">kubernetes/*</span><span class="w">
</span></span></span></code></pre></div><p><strong>Build section</strong> uses the Docker build command to create the container image. The image name is set to project/code with the image tag. This will match the image name in deployment.yaml</p>
<p>Skaffold uses the current Git commit hash to calculate the image tag. The tag is added to the container image name automatically and set as an environment variable called $IMAGE.</p>
<p><strong>test section</strong>
Run any tests on the container image or application. The example file above runs a container structure test that checks the container for defects then a custom Node.js test to</p>
<p><strong>deploy section</strong>
Uses kubernetes manifest files in /kubernetes directory to release the deployment. A patch is placed on the current deployment and the container tag and image are replaced.</p>
<p><strong>container-structure-test</strong>
Run on the container after it is built and after the application has been tested.</p>
<p>In this case, the test is located in the application&rsquo;s subdirectory /container-structure-tool/ in a file called structure-tool.yaml</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">commandTests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;telnet-server&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;./telnet-server&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;-i&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">expectedOutput</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;telnet port :2323\nMetrics Port: :9000&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadataTest</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">TELNET_PORT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="m">2323</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">METRIC_PORT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="m">9000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cmd</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;./telnet-server&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">workdir</span><span class="p">:</span><span class="w"> </span><span class="l">&#34;/app</span><span class="w">
</span></span></span></code></pre></div><p><strong>commandTests</strong>
command that runs the binary and args adds the -i option to output info to STDOUT. The output must match the &ldquo;expectedOutput&rdquo; value in order to pass the test.</p>
<p><strong>metadataTest</strong>
Checks the Docker file to make sure variables, commands, and working directory data matches.</p>
<p><strong>skaffold run subcommand</strong>
Build&rsquo;s, tests, and deploys the application. Does not watch for new code changes.</p>
<p><strong>skaffold dev subcommand</strong>
Same as run but watches for changes in source code and automatically runs the tests on new changes.</p>
<p>Pods will quit running after you press ^C so add the &ndash;cleanup=false argument if you want it to keep running.</p>
<p>Ran while in the code directory you are running the test on.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ skaffold dev --cleanup<span class="o">=</span><span class="nb">false</span> 
</span></span><span class="line"><span class="cl">Listing files to watch... 
</span></span><span class="line"><span class="cl">- dftd/telnet-server Generating tags... 
</span></span><span class="line"><span class="cl"><span class="c1"># Sets the container tag number, based on current git commit hash.</span>
</span></span><span class="line"><span class="cl">- dftd/telnet-server -&gt; dftd/telnet-server:4622725 
</span></span><span class="line"><span class="cl">- Checking cache... 
</span></span><span class="line"><span class="cl">- dftd/telnet-server: Not found. Building 
</span></span><span class="line"><span class="cl">- Found <span class="o">[</span>minikube<span class="o">]</span> context, using <span class="nb">local</span> docker daemon. Building <span class="o">[</span>dftd/telnet-server<span class="o">]</span>
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">Successfully tagged dftd/telnet-server:4622725
</span></span><span class="line"><span class="cl"><span class="c1"># skaffold starts the test section</span>
</span></span><span class="line"><span class="cl">Starting test...
</span></span><span class="line"><span class="cl">Testing images...
</span></span><span class="line"><span class="cl"><span class="o">=======================================================</span>
</span></span><span class="line"><span class="cl"><span class="o">======</span> Test file: command-and-metadata-test.yaml <span class="o">======</span>
</span></span><span class="line"><span class="cl"><span class="o">=======================================================</span>
</span></span><span class="line"><span class="cl"><span class="o">===</span> RUN: Command Test: telnet-server --- PASS duration: 571.602755ms stdout: telnet port :2323 Metrics Port: :9000 <span class="o">===</span> RUN: Metadata Test --- PASS duration: <span class="nv">0s</span> <span class="o">=======================================================</span> <span class="o">=======================</span> <span class="nv">RESULTS</span> <span class="o">=======================</span> <span class="o">=======================================================</span> Passes: <span class="m">2</span> Failures: <span class="m">0</span> Duration: 571.602755ms
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Total tests: <span class="m">2</span> PASS Running custom <span class="nb">test</span> command: <span class="s2">&#34;go test ./... -v&#34;</span> ? telnet-server <span class="o">[</span>no <span class="nb">test</span> files<span class="o">]</span> ? telnet-server/metrics <span class="o">[</span>no <span class="nb">test</span> files<span class="o">]</span> <span class="o">===</span> RUN TestServerRun Mocked charge notification <span class="k">function</span> TestServerRun: server_test.go:23: PASS: Run<span class="o">()</span> --- PASS: TestServerRun <span class="o">(</span>0.00s<span class="o">)</span> PASS ok telnet-server/telnet <span class="o">(</span>cached<span class="o">)</span> Command finished successfully.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Starts deploy</span>
</span></span><span class="line"><span class="cl">Starting deploy... - deployment.apps/telnet-server created - service/telnet-server created - service/telnet-server-metrics created Waiting <span class="k">for</span> deployments to stabilize... - deployment/telnet-server: waiting <span class="k">for</span> rollout to finish: <span class="m">0</span> of <span class="m">2</span> updated replicas are available... - pod/telnet-server-6497d64d7f-j8jq5: creating container telnet-server - pod/telnet-server-6497d64d7f-sx5ll: creating container telnet-server - deployment/telnet-server: waiting <span class="k">for</span> rollout to finish: <span class="m">1</span> of <span class="m">2</span> updated replicas are available... - deployment/telnet-server is ready.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Deployments stabilized in 2.140948622s **Press Ctrl+C to exit** Watching <span class="k">for</span> changes...
</span></span></code></pre></div><p>Can use the debug flag if you have any errors for troubleshooting.</p>
<p>skaffold will skip the build and test phase if there are no changes detected. -dirty is added to the end of the tag if the repo has uncommited changes.</p>
<p>Once you make a code change, the process will be re-run automatically if the dev option is used.</p>
<p>You can use the minicube tunnel command to jump to the server to test.</p>
<p>Grab the ip of the server:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ minikube kubectl -- get services telnet-server
</span></span><span class="line"><span class="cl">NAME TYPE CLUSTER-IP EXTERNAL-IP PORT<span class="o">(</span>S<span class="o">)</span> AGE 
</span></span><span class="line"><span class="cl">telnet-server LoadBalancer 10.105.161.160 **10.105.161.160** 2323:30488/TCP 6m40s
</span></span></code></pre></div><p>Verify that new pods are running:
<code>minikube kubectl</code></p>
<p>Rolling back</p>
<p>If there is no immediate disruption in service then you can deploy a hot fix and run it through the CI/CD pipeline again. If your service is down and you just need to bring it up, then just use Kubernetes to roll back.</p>
<ol>
<li>Check the rollout history:</li>
</ol>
<ul>
<li>Kubernetes tracks deployments and saves states of previous versions.</li>
</ul>
<p>To check deployment history:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">minikube kubectl -- rollout <span class="nb">history</span> deployment telnet-server
</span></span><span class="line"><span class="cl">deployment.apps/telnet-server
</span></span><span class="line"><span class="cl">REVISION CHANGE-CAUSE
</span></span><span class="line"><span class="cl"><span class="m">1</span>           &lt;none&gt;
</span></span><span class="line"><span class="cl"><span class="m">2</span>           &lt;none&gt;
</span></span></code></pre></div><p>Revision 2 is the current active.</p>
<p>To rollback to revision 1:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">minikube kubectl -- rollout undo deployment telnet-server --to-revision<span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">deployment.apps/telnet-server rolled back
</span></span></code></pre></div><p>Or leave off the <code>--to-revision</code> option to just roll back to the previous version.</p>
<p>Verify:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">minikube kubectl -- get pods
</span></span><span class="line"><span class="cl">NAME READY STATUS RESTARTS AGE telnet-server-7fb57bd65f-qc8rg 1/1 Running <span class="m">0</span> 28s telnet-server-7fb57bd65f-wv4t9 1/1 Running <span class="m">0</span> 29s
</span></span></code></pre></div><p>Enter the app to verify the change</p>
<p>The new revision is version 3 as listed with the <code>rollout history</code> command.</p>
<p>If your company focuses on Mean Time to Recovery (MTTR), this technique helps the service go back up as fast as possible from a customer&rsquo;s point of view.</p>

            </div>
        </article></main>
</div>
<footer class="footer">
    <span class="footer_item"> </span>
    &nbsp;

    <div class="footer_social-icons">
<a href="https://github.com/davidvargasxyz" target="_blank" rel="noopener noreferrer me"
    title="Github">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path
        d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22">
    </path>
</svg>
</a>
<a href="https://keybase.io/" target="_blank" rel="noopener noreferrer me"
    title="Keybase">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 71 76.3" version="1.1" fill="currentColor" stroke="none">
    <path
        d="M6.68 73.99c-.6-1.3-1.4-3.1-1.8-4l-.6-1.7-2 2.2-2 2.2-.2-4.2c-.3-6 .2-12.2 1.2-16.6 2.3-9.8 9.5-18.7 18.8-23.4l2.1-1-.5-1.5c-.3-.8-.6-2.5-.7-3.6l-.2-2.1-2.1-.2c-3.2-.3-4.9-1.2-6-3.5-.6-1.2-.6-1.4-.4-4.6.2-4.2.5-5.1 1.8-6.5 1.6-1.8 2.7-2.1 6.7-1.9 2.9.2 3.5.3 4.8.9.8.4 1.5.8 1.6.8.1 0 1-1.1 2.1-2.6l1.9-2.7 1.2.7c.7.4 1.5.9 1.9 1.1l.7.4-.6 1.5c-.3.8-.7 2.2-.8 2.9l-.2 1.4 1.7.2c6.1.6 10.7 4.3 12.4 9.9.5 1.8.5 5.3 0 7-.5 1.6-.5 1.7-.1 1.7.7 0 5.4 2.3 7.3 3.5 3.7 2.4 8 6.6 10.4 10.2 4.5 6.7 6.4 14 5.6 22-.4 4.8-1.3 8.6-2.9 12.3l-.6 1.4h-5l1.2-2.4c1.3-2.6 2.3-6.2 2.8-9.4.3-2.2.4-8.2.1-9.3l-.2-.7-1.3 1.4c-3.2 3.5-7.9 4.5-14.2 2.8-5.4-1.4-7.6-1.7-12.7-1.7-3.9 0-5.2.1-7.3.6-5.8 1.3-9.9 3.2-15.6 7.3-2.1 1.5-3.8 2.7-3.9 2.7-.1 0 .2-1 .6-2.3.4-1.3 1.1-3.4 1.5-4.8l.8-2.5-.9.9c-.5.5-1.9 1.9-3.1 3.2l-2.1 2.3.5 1.9c.6 2.5 2 5.6 3.5 7.9.6 1 1.1 1.8 1.1 1.9s-1.2.1-2.6.1h-2.6l-1.1-2.1zm8.8-24.2c4.8-5.1 8.7-9.2 8.8-9.2.1.1-.4 1.6-.9 3.3-3.3 10.4-4 12.4-3.9 12.5 0 0 1.2-.4 2.5-.9 8.5-3.7 18.4-4.2 28.9-1.4 4.7 1.2 6.5 1.2 8.8 0 1.3-.7 1.8-1.1 2.4-2.1 1.1-1.7 1.2-4.1.5-6.3-1.7-4.8-8.3-11-14.5-13.7-3.2-1.4-3.4-1.4-4.1-.7l-.6.6 2.6 3.2c1.4 1.7 2.9 3.6 3.1 4.1.6 1.2.7 3.1.1 4.3-.8 1.7-3.2 2.9-5.1 2.5-.8-.2-1.1-.1-1.9.5-2.2 1.6-4.6 1.2-6.6-1.2-1.6-1.8-2-2.7-2.1-4.5 0-.9-.3-2-.5-2.4-.3-.6-.4-1.3-.4-2.2l.1-1.4-1.3-.3c-1.8-.5-3.9-1.5-5.1-2.4-.6-.4-1.1-.8-1.3-.8s-1.5.6-2.9 1.3c-9.7 5-16 14.3-17 24.8-.1 1-.2 2.3-.3 2.8l-.1.9 1.1-1.1c.5-.5 4.9-5.1 9.7-10.2zm25.9-7.4c.9-.7 1.7-1.3 1.9-1.3.1 0 .4.3.7.7.5.8 1.4.8 1.8.1.3-.5.3-.6-5.6-7.8-3.5-4.3-4.2-5-4.7-5-1.2.1-.9 1 1 3.3l1.8 2.2-1 .8c-1.1 1-1.2 1.2-.5 1.8.5.5.6.4 1.6-.3l1.1-.7.7.6c.4.3.6.8.6.9 0 .2-.8.9-1.7 1.7-.9.7-1.6 1.5-1.6 1.7 0 .3.5 1.1 1.4 2.2.3.6.8.4 2.5-.9zm-10.3-14.2c.6-1.8 2.6-3.2 4.6-3.2 1.1 0 2.7.9 3.8 2.1l1 1.2.9-1.1c2.5-2.8 2.8-6.7.8-10.1-1.5-2.5-4.3-4-8.2-4.4-2.1-.2-2.6-.4-3.7-1.5l-.8-.8-.4.6c-.8 1.2-2.5 5.1-3 6.6-.7 2.3-.4 5.9.5 7.7.9 1.7 3.3 4 4 3.7.1.1.3-.3.5-.8zm-8.9-13.6c.2-.5.7-1.8 1.2-2.8.5-1 .9-2 .9-2.3 0-.9-1-1.3-3.7-1.5-2.4-.2-2.6-.1-3.1.4-.4.4-.6.9-.6 1.6 0 .6-.1 1.7-.2 2.6-.2 2.1.1 2.5 2.2 2.8 3.1.2 3 .2 3.3-.8zm-3.1-2.4c0-1.7.2-1.9 1.6-1.9h1.3v2.8h-2.8v-.9zm6.3 58.3c-.6-.6-.8-1-.8-2 0-1.9 1.1-3 2.9-3 1.7 0 2.9 1.2 2.9 2.9 0 1.8-1.1 2.8-3 2.9-1 0-1.4-.2-2-.8zm19.3.3a2.93 2.93 0 011.8-5.3c1.8 0 2.8 1.1 2.9 3 0 1.1-.1 1.4-.8 2s-1 .8-2 .8c-.9 0-1.5-.2-1.9-.5z" />
</svg>
</a>
<a href="index.xml" target="_blank" rel="noopener noreferrer me"
    title="Rss">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path d="M4 11a9 9 0 0 1 9 9" />
    <path d="M4 4a16 16 0 0 1 16 16" />
    <circle cx="5" cy="19" r="1" />
</svg>
</a>
</div>
    <small class="footer_copyright">
        © 2024 David Vargas.
        Powered by <a href="https://github.com/hugo-sid/hugo-blog-awesome" target="_blank" rel="noopener">Hugo blog awesome</a>.
    </small>
</footer><a href="#" title="Go to top" id="totop">
    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" stroke="currentColor" viewBox="0 96 960 960">
    <path d="M283 704.739 234.261 656 480 410.261 725.739 656 677 704.739l-197-197-197 197Z"/>
</svg>

</a>


    






    
    <script src="https://davidvargas.xyz/js/main.min.35f435a5d8eac613c52daa28d8af544a4512337d3e95236e4a4978417b8dcb2f.js" integrity="sha256-NfQ1pdjqxhPFLaoo2K9USkUSM30&#43;lSNuSkl4QXuNyy8="></script>

    

</body>
</html>
